# ROS地图编辑器插件 项目摘要

## 项目概述

这是一个功能完整的ROS地图编辑器插件，集成了地图加载、编辑、虚拟墙绘制、区域标注等功能。插件基于RViz Panel架构，提供直观的用户界面和强大的编辑能力。

## 版本历史

### v2.3 (最新版本) - 2024年6月16日
**正方形画笔精确版本**

#### 关键修复
- **正方形画笔算法**：将橡皮擦从圆形画笔改为正方形画笔
- **精确像素控制**：画笔大小N表示NxN像素的正方形区域
- **消除十字形问题**：修复小画笔大小时出现十字形的问题

#### 画笔行为
- **大小为1**：擦除1x1像素（1个像素）
- **大小为2**：擦除2x2像素（4个像素）
- **大小为3**：擦除3x3像素（9个像素）
- **大小为5**：擦除5x5像素（25个像素）

#### 对齐规则
- **奇数大小**（1,3,5...）：以点击位置为中心对齐
- **偶数大小**（2,4,6...）：向右下方向偏移

#### 技术改进
- 使用整数坐标计算，避免浮点精度问题
- 统一C++和Python版本的画笔算法
- 更新状态显示为"NxN像素"格式
- 添加专门的正方形画笔测试脚本

#### 文件变更
- `map_eraser_tool.cpp`：重写 `eraseAtPoint()` 方法使用正方形算法
- `map_edit.py`：更新 `draw_point()` 方法匹配C++版本
- `test_square_brush.sh`：新增正方形画笔测试脚本

### v2.2 (最新版本) - 2024年6月16日
**用户体验增强版本**

#### 新功能
- **智能文件对话框**：打开地图时自动定位到 `ros_map_edit/maps` 目录
- **完整消息清空机制**：加载新地图前先清空所有ROS话题消息
- **增强测试环境**：添加多地图测试场景验证消息清空功能

#### 功能改进
- 文件对话框默认路径智能检测（多路径回退机制）
- 加载地图前完整清空所有显示内容（地图、虚拟墙、区域）
- 多重话题清空保障（map、map_edited、虚拟墙、区域marker）
- 创建test2地图用于切换测试

#### 文件变更
- `map_edit_panel.cpp`：增加 `clearAllMessages()` 方法和文件对话框路径设置
- `map_edit_panel.h`：添加新方法声明
- `test_file_dialog.sh`：新增完整测试脚本

### v2.1 - 2024年6月16日
**智能文件管理版本**

#### 新功能
- **橡皮擦工具像素化**：将橡皮擦工具从米制改为像素制（1-10像素）
- **智能文件加载系统**：加载地图时自动查找并加载对应的虚拟墙和区域文件
- **空数据发布机制**：无对应文件时发布空marker数组，避免显示旧数据

#### 关键特性
- 橡皮擦工具范围：1-10像素（原1-10米）
- 自动文件关联：`map.yaml` → `map.json` + `map_region.json`
- 内存清理：加载新数据前先清空现有数据
- 参数服务器集成：使用 `/map_server/map_file` 检测当前地图

### v2.0 - ROS标准兼容版本

#### 核心修复
- **YAML解析修复**：解决 "bad conversion" 错误，支持整数和布尔值的negate字段
- **PGM格式规范化**：完全兼容ROS map_server的PGM P5格式解析
- **参数标准化**：occupied_thresh、free_thresh、negate参数符合ROS规范

#### 技术实现
- 灵活的YAML字段解析（整数转布尔值处理）
- 标准PGM注释行跳过机制
- 宽松的宽度/高度解析（支持多空格分隔）
- 完整的错误处理和状态反馈

### v1.x - 基础功能版本

#### 核心功能
- **地图编辑**：支持PGM和YAML格式的地图文件加载和保存
- **虚拟墙工具**：绘制、编辑、删除虚拟墙线段
- **区域标注工具**：创建、编辑多边形区域（清洁区域、禁行区等）
- **橡皮擦工具**：可调节大小的地图擦除功能
- **一键保存**：同时保存地图、虚拟墙、区域数据

## 核心技术架构

### 文件管理系统
- **MapFileManager**：统一的文件读写管理器
- **格式支持**：YAML(地图配置) + PGM(图像) + JSON(虚拟墙/区域)
- **ROS兼容**：完全符合map_server标准

### 工具系统
- **ToolManager**：单例模式的工具管理器
- **MapEraserTool**：像素级橡皮擦（1-10像素范围）
- **VirtualWallTool**：虚拟墙绘制和管理
- **RegionTool**：多边形区域标注

### ROS集成
- **话题发布**：map、map_edited、虚拟墙和区域marker
- **参数服务器**：与map_server参数同步
- **RViz集成**：原生Panel插件架构

## 文件结构

```
src/ros_map_edit/
├── include/ros_map_edit/          # 头文件
│   ├── map_edit_panel.h          # 主面板
│   ├── map_file_manager.h        # 文件管理
│   ├── tool_manager.h            # 工具管理
│   └── [tool_name]_tool.h        # 各种工具
├── src/                          # 源代码
│   ├── map_edit_panel.cpp        # 主面板实现
│   ├── map_file_manager.cpp      # 文件管理实现
│   └── [tool_name]_tool.cpp      # 工具实现
├── maps/                         # 测试地图
│   ├── test.yaml/pgm/json        # 第一个测试地图
│   └── test2.yaml/pgm/json       # 第二个测试地图（含数据）
├── config/                       # 配置文件
│   └── map_edit.rviz             # RViz配置
├── scripts/                      # 测试脚本
│   ├── test_map_loading.sh       # 地图加载测试
│   └── test_file_dialog.sh       # 文件对话框测试
└── plugin.xml                    # RViz插件配置
```

## 使用方法

### 基本操作流程
1. **启动RViz**：`rviz -d src/ros_map_edit/config/map_edit.rviz`
2. **打开地图**：在MapEditPanel中点击"打开地图"，自动定位到maps目录
3. **编辑地图**：使用橡皮擦工具修改地图（1-10像素画笔）
4. **添加虚拟墙**：使用VirtualWall工具绘制禁行线
5. **标注区域**：使用Region工具创建功能区域
6. **保存结果**：点击"一键保存所有文件"

### 智能文件管理
- 地图文件：`map.yaml` + `map.pgm`
- 虚拟墙：`map.json`（与地图同名）
- 区域数据：`map_region.json`（地图名+_region后缀）
- 自动关联：加载地图时自动查找并加载对应文件
- 空数据处理：无对应文件时发布空数据，清除旧显示

### 消息清空机制
- 切换地图前先清空所有ROS话题
- 清空内容：地图、编辑地图、虚拟墙marker、区域marker
- 防止旧数据干扰新地图显示

## 测试验证

### 自动化测试
```bash
# 基础功能测试
./src/ros_map_edit/scripts/test_map_loading.sh

# 文件对话框和消息清空测试
./src/ros_map_edit/scripts/test_file_dialog.sh
```

### 手动测试场景
1. **文件对话框测试**：验证默认路径为ros_map_edit/maps
2. **消息清空测试**：test2→test切换，观察虚拟墙和区域清空
3. **智能文件加载**：验证对应文件自动加载

## 技术特点

### 用户体验
- 🎯 **智能路径定位**：文件对话框自动定位到地图目录
- 🧹 **完整数据清空**：切换地图时彻底清除旧数据显示
- 📏 **像素级精度**：橡皮擦工具使用像素单位，精确控制
- 🔄 **自动文件关联**：智能加载对应的虚拟墙和区域文件

### 技术可靠性
- ✅ **ROS标准兼容**：完全符合map_server和导航系统标准
- 🔒 **错误处理完善**：全面的异常捕获和状态反馈
- 🔧 **模块化设计**：工具管理器统一管理所有编辑工具
- 📊 **状态同步**：与ROS参数服务器实时同步

### 开发友好
- 🧪 **完整测试覆盖**：多层次测试脚本验证功能
- 📝 **详细文档**：完整的使用说明和API文档
- 🔨 **易于扩展**：标准化的工具接口，便于添加新功能
- 🐛 **调试支持**：详细的日志输出和状态显示

## 下一步规划

### 功能增强
- 地图层次编辑（多层地图支持）
- 批量文件处理工具
- 地图格式转换器
- 实时协作编辑

### 性能优化
- 大地图加载优化
- 内存使用优化
- 渲染性能提升
- 实时预览优化

---

**开发团队**：REINOVO  
**最新更新**：2024年6月16日  
**版本**：v2.3  
**ROS版本**：ROS1 Noetic  
**测试环境**：Ubuntu 20.04 LTS