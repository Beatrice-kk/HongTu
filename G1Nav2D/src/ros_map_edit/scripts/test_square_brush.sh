#!/bin/bash

# æµ‹è¯•æ­£æ–¹å½¢ç”»ç¬”åŠŸèƒ½

echo "ğŸ–Œï¸  æµ‹è¯•æ­£æ–¹å½¢æ©¡çš®æ“¦ç”»ç¬”åŠŸèƒ½"
echo "========================================"

# è®¾ç½®ç¯å¢ƒ
source devel/setup.bash

# æ£€æŸ¥æµ‹è¯•åœ°å›¾æ˜¯å¦å­˜åœ¨
if [ ! -f "src/ros_map_edit/maps/test.yaml" ]; then
    echo "âŒ æµ‹è¯•åœ°å›¾ä¸å­˜åœ¨ï¼Œæ­£åœ¨ç”Ÿæˆ..."
    python3 src/py_pkg/scripts/create_test_map.py
fi

echo "âœ… æµ‹è¯•åœ°å›¾å·²å‡†å¤‡å°±ç»ª"

# å¯åŠ¨roscoreï¼ˆå¦‚æœæ²¡æœ‰è¿è¡Œï¼‰
if ! pgrep -x "roscore" > /dev/null; then
    echo "ğŸš€ å¯åŠ¨roscore..."
    roscore &
    ROSCORE_PID=$!
    sleep 3
else
    echo "âœ… roscoreå·²åœ¨è¿è¡Œ"
    ROSCORE_PID=""
fi

# å¯åŠ¨åœ°å›¾æœåŠ¡å™¨
echo "ğŸ—ºï¸  å¯åŠ¨åœ°å›¾æœåŠ¡å™¨..."
rosrun map_server map_server src/ros_map_edit/maps/test.yaml &
MAP_SERVER_PID=$!
sleep 2

echo "ğŸ“Š æ­£æ–¹å½¢ç”»ç¬”æµ‹è¯•è¯´æ˜ï¼š"
echo "========================================"
echo "ç”»ç¬”å¤§å°æµ‹è¯•ï¼š"
echo "â€¢ 1åƒç´  = 1x1æ­£æ–¹å½¢ï¼ˆ1ä¸ªåƒç´ ï¼‰"
echo "â€¢ 2åƒç´  = 2x2æ­£æ–¹å½¢ï¼ˆ4ä¸ªåƒç´ ï¼‰"
echo "â€¢ 3åƒç´  = 3x3æ­£æ–¹å½¢ï¼ˆ9ä¸ªåƒç´ ï¼‰"
echo "â€¢ 5åƒç´  = 5x5æ­£æ–¹å½¢ï¼ˆ25ä¸ªåƒç´ ï¼‰"
echo ""
echo "å¯¹é½è§„åˆ™ï¼š"
echo "â€¢ å¥‡æ•°å¤§å°ï¼ˆ1,3,5...ï¼‰ï¼šä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒ"
echo "â€¢ å¶æ•°å¤§å°ï¼ˆ2,4,6...ï¼‰ï¼šå‘å³ä¸‹åç§»"
echo ""
echo "ğŸ§ª æµ‹è¯•æ­¥éª¤ï¼š"
echo "1. å¯åŠ¨RVizï¼š"
echo "   rviz -d src/ros_map_edit/config/map_edit.rviz"
echo ""
echo "2. é€‰æ‹©æ©¡çš®æ“¦å·¥å…·ï¼ˆMapEraserToolï¼‰"
echo ""
echo "3. æµ‹è¯•ä¸åŒç”»ç¬”å¤§å°ï¼š"
echo "   â€¢ è®¾ç½®ç”»ç¬”å¤§å°ä¸º1ï¼Œæµ‹è¯•å•åƒç´ "
echo "   â€¢ è®¾ç½®ç”»ç¬”å¤§å°ä¸º2ï¼ŒéªŒè¯2x2æ­£æ–¹å½¢"
echo "   â€¢ è®¾ç½®ç”»ç¬”å¤§å°ä¸º3ï¼ŒéªŒè¯3x3æ­£æ–¹å½¢"
echo "   â€¢ è®¾ç½®ç”»ç¬”å¤§å°ä¸º5ï¼ŒéªŒè¯5x5æ­£æ–¹å½¢"
echo ""
echo "4. éªŒè¯æ•ˆæœï¼š"
echo "   â€¢ å·¦é”®ï¼šç”»é»‘è‰²ï¼ˆéšœç¢ç‰©ï¼‰"
echo "   â€¢ å³é”®ï¼šç”»ç™½è‰²ï¼ˆè‡ªç”±ç©ºé—´ï¼‰"
echo "   â€¢ æ‹–æ‹½ï¼šè¿ç»­ç»˜åˆ¶"
echo ""
echo "5. æ£€æŸ¥çŠ¶æ€æ ä¿¡æ¯ï¼š"
echo "   åº”è¯¥æ˜¾ç¤ºç±»ä¼¼ï¼š'é»‘ç™½æ©¡çš®æ“¦ - ç¬”åˆ·: 3x3åƒç´ , å·¦é”®:é»‘è‰² å³é”®:ç™½è‰²'"
echo ""
echo "6. æµ‹è¯•Pythonç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰ï¼š"
echo "   python3 src/py_pkg/scripts/map_edit.py"
echo ""

# åˆ›å»ºæµ‹è¯•æ—¥å¿—
echo "ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ï¼š"
echo "- ROSç‰ˆæœ¬: $(rosversion -d)"
echo "- å·¥ä½œç›®å½•: $(pwd)"
echo "- åœ°å›¾æ–‡ä»¶: $(ls -la src/ros_map_edit/maps/test.* | wc -l) ä¸ªæ–‡ä»¶"

echo ""
echo "ğŸ“ˆ é¢„æœŸç»“æœï¼š"
echo "âœ“ ç”»ç¬”å¤§å°1ï¼šåªæ“¦é™¤ç‚¹å‡»çš„å•ä¸ªåƒç´ "
echo "âœ“ ç”»ç¬”å¤§å°2ï¼šæ“¦é™¤2x2åƒç´ æ­£æ–¹å½¢åŒºåŸŸ"
echo "âœ“ ç”»ç¬”å¤§å°3ï¼šæ“¦é™¤3x3åƒç´ æ­£æ–¹å½¢åŒºåŸŸï¼ˆä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒï¼‰"
echo "âœ“ ç”»ç¬”å¤§å°5ï¼šæ“¦é™¤5x5åƒç´ æ­£æ–¹å½¢åŒºåŸŸï¼ˆä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒï¼‰"
echo "âœ“ çŠ¶æ€æ æ­£ç¡®æ˜¾ç¤º'NxNåƒç´ 'æ ¼å¼"
echo "âœ“ ä¸å†å‡ºç°åå­—å½¢æˆ–åœ†å½¢æ•ˆæœ"

# æ¸…ç†å‡½æ•°
cleanup() {
    echo ""
    echo "ğŸ§¹ æ¸…ç†è¿›ç¨‹..."
    if [ ! -z "$MAP_SERVER_PID" ]; then
        kill $MAP_SERVER_PID 2>/dev/null
    fi
    if [ ! -z "$ROSCORE_PID" ]; then
        kill $ROSCORE_PID 2>/dev/null
    fi
    echo "âœ… æ¸…ç†å®Œæˆ"
}

# è®¾ç½®æ¸…ç†é™·é˜±
trap cleanup EXIT

echo ""
echo "â³ æŒ‰Ctrl+Cé€€å‡ºæµ‹è¯•..."

# ä¿æŒè„šæœ¬è¿è¡Œï¼Œè®©ç”¨æˆ·å¯ä»¥æµ‹è¯•
while true; do
    sleep 1
done 